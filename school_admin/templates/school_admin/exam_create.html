{% extends 'accounts/base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="min-h-screen bg-gray-100 p-4 sm:p-6 flex justify-center">

  <div class="w-full max-w-3xl">

    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-{{ school.theme_color }}-800">
        Create Exam
      </h1>
      <p class="text-sm text-gray-600 mt-1">
        {{ school.name }} â€” Exam setup
      </p>
    </div>

    <!-- Form Card -->
    <form method="post"
          class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 sm:p-8 space-y-6">
      {% csrf_token %}

      <!-- MAIN FIELDS -->
      {% for field in form %}
        {% if field.name != "start_time" and field.name != "end_time" and field.name != "duration_minutes" %}
          <div>
            <label class="block text-gray-700 font-semibold mb-2">
              {{ field.label }}
              {% if field.field.required %}
                <span class="text-red-500">*</span>
              {% endif %}
            </label>

            {% if field.field.widget.input_type == "text" or field.field.widget.input_type == "textarea" %}
              <!-- MathLive input -->
              <math-field
                class="equation-field w-full border rounded-lg px-3 py-2 bg-white"
                style="min-height:80px;"></math-field>

              <!-- Hidden real field -->
              <input type="hidden"
                     name="{{ field.html_name }}"
                     class="mathlive-hidden"
                     value="{{ field.value|default_if_none:'' }}">
            {% else %}
              {{ field|add_class:"w-full border rounded-lg px-3 py-2" }}
            {% endif %}

            {% for error in field.errors %}
              <p class="text-red-500 text-sm mt-1">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}
      {% endfor %}

      <!-- TIME & DURATION -->
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">

        <div>
          <label class="block text-gray-700 font-semibold mb-2">
            Start Time
          </label>
          {{ form.start_time|add_class:"w-full border rounded-lg px-3 py-2" }}
          {% for error in form.start_time.errors %}
            <p class="text-red-500 text-sm mt-1">{{ error }}</p>
          {% endfor %}
        </div>

        <div>
          <label class="block text-gray-700 font-semibold mb-2">
            End Time
          </label>
          {{ form.end_time|add_class:"w-full border rounded-lg px-3 py-2" }}
          {% for error in form.end_time.errors %}
            <p class="text-red-500 text-sm mt-1">{{ error }}</p>
          {% endfor %}
        </div>

        <div>
          <label class="block text-gray-700 font-semibold mb-2">
            Duration (minutes)
          </label>
          {{ form.duration_minutes|add_class:"w-full border rounded-lg px-3 py-2" }}
          {% for error in form.duration_minutes.errors %}
            <p class="text-red-500 text-sm mt-1">{{ error }}</p>
          {% endfor %}
        </div>

      </div>

      <!-- SUBMIT -->
      <div class="pt-4">
        <button type="submit"
                class="w-full sm:w-auto bg-gradient-to-r from-indigo-500 to-indigo-600
                       hover:from-indigo-600 hover:to-indigo-700
                       text-white font-semibold px-6 py-3 rounded-lg transition">
          Create Exam
        </button>
      </div>

      <!-- NON FIELD ERRORS -->
      {% if form.non_field_errors %}
        <div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
          {% for error in form.non_field_errors %}
            <p class="text-red-600 text-sm">{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}

    </form>
  </div>
</div>

<!-- ================= MATHLIVE ================= -->
<script type="module">
  import 'https://unpkg.com/mathlive?module';
</script>

<!-- ================= SYNC SCRIPT ================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const mathFields = document.querySelectorAll('.equation-field');
  const hiddenInputs = document.querySelectorAll('.mathlive-hidden');

  mathFields.forEach(function (mf, index) {
    const hidden = hiddenInputs[index];
    if (!hidden) return;

    // preload existing LaTeX
    if (hidden.value) {
      mf.setValue(hidden.value, { format: 'latex' });
    }

    mf.addEventListener('input', function () {
      hidden.value = mf.getValue('latex');
    });
  });
});
</script>

<style>
math-field {
  display: block;
  min-height: 70px;
  cursor: text;
  user-select: text;
}
</style>

{% endblock %}
