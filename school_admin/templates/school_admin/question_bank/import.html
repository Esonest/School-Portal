{% extends "accounts/base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 py-6">

  <!-- PAGE TITLE -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-{{ school.theme_color }}-600">
      Import Questions to {{ exam.title }}
    </h1>
  </div>

  <!-- FILTERS -->
  <form method="get" id="filterForm"
        class="mb-6 grid grid-cols-1 sm:grid-cols-5 gap-4">

    <select name="class" onchange="this.form.submit()" class="border rounded-lg px-3 py-2">
      <option value="">All Classes</option>
      {% for c in classes %}
        <option value="{{ c.id }}" {% if request.GET.class == c.id|stringformat:"s" %}selected{% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>

    <select name="subject" class="border rounded-lg px-3 py-2">
      <option value="">All Subjects</option>
      {% for subject in subjects %}
        <option value="{{ subject.id }}" {% if request.GET.subject == subject.id|stringformat:"s" %}selected{% endif %}>
          {{ subject.name }}
        </option>
      {% endfor %}
    </select>

    <select name="topic" class="border rounded-lg px-3 py-2">
      <option value="">All Topics</option>
      {% for topic in topics %}
        <option value="{{ topic.id }}" {% if request.GET.topic == topic.id|stringformat:"s" %}selected{% endif %}>
          {{ topic.name }}
        </option>
      {% endfor %}
    </select>

    <select name="session" class="border rounded-lg px-3 py-2">
      <option value="">All Sessions</option>
      {% for s in sessions %}
        <option value="{{ s }}" {% if request.GET.session == s %}selected{% endif %}>
          {{ s }}
        </option>
      {% endfor %}
    </select>

    <button type="submit"
            class="bg-indigo-600 text-white rounded-lg px-4 py-2 hover:bg-indigo-700">
      Search
    </button>
  </form>

  <!-- IMPORT FORM -->
  <form method="post">
    {% csrf_token %}

    <!-- ================= MOBILE ================= -->
    <div class="grid grid-cols-1 gap-4 sm:hidden">
      {% for q in questions %}
        <label class="bg-white rounded-xl shadow p-4 space-y-3 cursor-pointer">

          <div class="flex gap-3">
            <input type="checkbox"
                   class="question-checkbox mt-1"
                   name="questions"
                   value="{{ q.id }}"
                   {% if q.text in imported_texts %}disabled{% endif %}>

            <div class="flex-1">
              <div class="text-gray-800 font-medium">
                {{ q.text|safe }}
              </div>

              {% if q.equation %}
                <div class="mt-2 text-lg mathjax">
                  {{ q.equation }}
                </div>
              {% endif %}

              <div class="flex justify-between text-sm text-gray-600 mt-2">
                <span><strong>Subject:</strong> {{ q.subject.name }}</span>
                <span><strong>Marks:</strong> {{ q.marks }}</span>
              </div>

              {% if q.text in imported_texts %}
                <span class="inline-block mt-2 text-xs font-semibold text-red-600">
                  Already Imported
                </span>
              {% endif %}
            </div>
          </div>

        </label>
      {% empty %}
        <div class="text-center text-gray-500 py-10">
          No questions available.
        </div>
      {% endfor %}
    </div>

    <!-- ================= DESKTOP ================= -->
    <div class="hidden sm:block bg-white rounded-xl shadow overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="px-4 py-3">
              <input type="checkbox" id="selectAll">
            </th>
            <th class="px-4 py-3 text-left">Question</th>
            <th class="px-4 py-3 text-center">Subject</th>
            <th class="px-4 py-3 text-center">Marks</th>
          </tr>
        </thead>

        <tbody class="divide-y">
          {% for q in questions %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3">
              <input type="checkbox"
                     class="question-checkbox"
                     name="questions"
                     value="{{ q.id }}"
                     {% if q.text in imported_texts %}disabled{% endif %}>
            </td>

            <td class="px-4 py-3 max-w-xl">
              <div>
                {{ q.text|safe }}
              </div>

              {% if q.equation %}
                <div class="mt-2 text-lg mathjax">
                  {{ q.equation }}
                </div>
              {% endif %}

              {% if q.text in imported_texts %}
                <span class="text-xs font-semibold text-red-600">
                  Already Imported
                </span>
              {% endif %}
            </td>

            <td class="px-4 py-3 text-center">{{ q.subject.name }}</td>
            <td class="px-4 py-3 text-center">{{ q.marks }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="px-4 py-8 text-center text-gray-500">
              No questions available.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ACTION BUTTON -->
    <div class="flex justify-end mt-8">
      <button type="submit"
              class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">
        Import Selected Questions
      </button>
    </div>

  </form>
</div>

<!-- SELECT ALL -->
<script>
  const selectAll = document.getElementById("selectAll");
  if (selectAll) {
    selectAll.addEventListener("change", function () {
      document
        .querySelectorAll(".question-checkbox:not(:disabled)")
        .forEach(cb => cb.checked = this.checked);
    });
  }
</script>

{% endblock %}
