{% extends "accounts/base.html" %}

{% block content %}

<style>
/* ===================== */
/* PRINT – A4 OPTIMIZED */
/* ===================== */
@media print {

  @page {
    size: A4 portrait;
    margin: 15mm;
  }

  body {
    background: white !important;
    color: black !important;
    font-size: 11px;
  }

  /* WATERMARK */
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background-image: url("{% if school.logo %}{{ school.logo.url }}{% endif %}");
    background-repeat: no-repeat;
    background-position: center;
    background-size: 380px;
    opacity: 0.06;
    z-index: -1;
  }

  /* HIDE UI */
  form, button, a[href], canvas {
    display: none !important;
  }

  /* TABLE FIX */
  table {
    width: 100% !important;
    border-collapse: collapse;
  }

  th, td {
    border: 1px solid #333 !important;
    padding: 6px !important;
  }

  thead {
    display: table-header-group;
  }

  tr {
    page-break-inside: avoid;
  }
}
</style>

<div class="max-w-7xl mx-auto px-4 py-8 space-y-8 bg-gray-50">

  <!-- ========================== -->
  <!-- HEADER -->
  <!-- ========================== -->
  <div class="flex flex-col md:flex-row justify-between md:items-center gap-4
              bg-white border rounded-2xl p-6 shadow">
    <h2 class="text-2xl font-bold text-{{ school.theme_color }}-700">
      Teachers Dashboard — {{ school.name }}
    </h2>

    <a href="{% url 'school_admin:teacher_create' school.id %}"
       class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700
              text-white rounded-lg shadow transition">
      + Add Teacher
    </a>
  </div>

  <!-- ========================== -->
  <!-- FILTER BAR -->
  <!-- ========================== -->
  <form method="GET"
        class="flex flex-col md:flex-row gap-4
               bg-white border rounded-xl p-4 shadow">
    <select name="class"
            class="border p-2 rounded w-full md:w-56 bg-white text-gray-800">
      <option value="">All Classes</option>
      {% for cls in classes %}
        <option value="{{ cls.id }}" {% if cls.id|stringformat:"s" == selected_class %}selected{% endif %}>
          {{ cls.name }}
        </option>
      {% endfor %}
    </select>

    <select name="subject"
            class="border p-2 rounded w-full md:w-56 bg-white text-gray-800">
      <option value="">All Subjects</option>
      {% for s in subjects %}
        <option value="{{ s.id }}" {% if s.id|stringformat:"s" == selected_subject %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>

    <button class="px-6 py-2 bg-gray-800 hover:bg-black
                   text-white rounded transition">
      Apply Filters
    </button>
  </form>

  <!-- ========================== -->
  <!-- CHARTS -->
  <!-- ========================== -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white border rounded-xl p-4 shadow">
      <h3 class="font-semibold mb-3 text-gray-800">
        Teachers per Class
      </h3>
      <canvas id="classChart"></canvas>
    </div>

    <div class="bg-white border rounded-xl p-4 shadow">
      <h3 class="font-semibold mb-3 text-gray-800">
        Teachers per Subject
      </h3>
      <canvas id="subjectChart"></canvas>
    </div>
  </div>

  <!-- ========================== -->
  <!-- TEACHERS TABLE -->
  <!-- ========================== -->
  <div class="overflow-x-auto bg-white border rounded-xl shadow">
    <table class="w-full min-w-max">
      <thead class="bg-gray-100 border-b">
        <tr>
          <th class="p-3 text-left font-semibold">Name</th>
          <th class="p-3 text-left font-semibold">Staff ID</th>
          <th class="p-3 text-left font-semibold">Classes</th>
          <th class="p-3 text-left font-semibold">Subjects</th>
          <th class="p-3 text-left font-semibold">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for t in teachers %}
        <tr class="border-b hover:bg-gray-50 transition">
          <td class="p-3 font-medium">{{ t.get_full_name }}</td>
          <td class="p-3 text-sm">{{ t.staff_id }}</td>
          <td class="p-3 text-sm">
            {% for cls in t.classes.all %}{{ cls.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
          </td>
          <td class="p-3 text-sm">
            {% for s in t.subjects.all %}{{ s.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
          </td>
          <td class="p-3 space-x-3 text-sm">
            <a href="{% url 'school_admin:teacher_edit' school.id t.id %}"
               class="text-indigo-600 hover:underline">
              Edit
            </a>
            <a href="{% url 'school_admin:teacher_delete' school.id t.id %}"
               class="text-red-600 hover:underline">
              Delete
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5"
              class="p-6 text-center text-gray-500">
            No teachers found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- ========================== -->
<!-- CHART.JS -->
<!-- ========================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const classData = {{ class_chart|safe }};
new Chart(document.getElementById('classChart'), {
  type: 'bar',
  data: {
    labels: classData.map(d => d['classes__name']),
    datasets: [{
      label: 'Teachers',
      data: classData.map(d => d.total),
      backgroundColor: '#3b82f6'
    }]
  }
});

const subjectData = {{ subject_chart|safe }};
new Chart(document.getElementById('subjectChart'), {
  type: 'bar',
  data: {
    labels: subjectData.map(d => d['subjects__name']),
    datasets: [{
      label: 'Teachers',
      data: subjectData.map(d => d.total),
      backgroundColor: '#10b981'
    }]
  }
});
</script>

{% endblock %}
