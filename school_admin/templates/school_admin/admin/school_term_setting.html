{% extends "accounts/base.html" %}

{% load static %}

{% block content %}
<div class="min-h-screen bg-gray-100 p-4 md:p-6">
    <div class="max-w-3xl mx-auto">

        <!-- Success/Error Messages -->
        {% if messages %}
        <div class="space-y-2 mb-4">
            {% for message in messages %}
                <div class="p-4 rounded border-l-4 {% if message.tags == 'success' %}bg-green-50 border-green-400 text-green-700{% elif message.tags == 'error' %}bg-red-50 border-red-400 text-red-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Card -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Academic Term Settings</h2>

            <form method="post" class="space-y-4">
                {% csrf_token %}

                <!-- Session -->
                <div>
                    <label for="session" class="block font-semibold text-gray-700 mb-1">Select Session:</label>
                    <select name="session" id="session" required class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        {% for s, label in sessions %}
                            <option value="{{ s }}" {% if term_setting.session == s %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Term -->
                <div>
                    <label for="term" class="block font-semibold text-gray-700 mb-1">Select Term:</label>
                    <select name="term" id="term" required class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="1" {% if term_setting.term|stringformat:"s" == "1" %}selected{% endif %}>Term 1</option>
                        <option value="2" {% if term_setting.term|stringformat:"s" == "2" %}selected{% endif %}>Term 2</option>
                        <option value="3" {% if term_setting.term|stringformat:"s" == "3" %}selected{% endif %}>Term 3</option>
                    </select>
                </div>

                <!-- Next Term Begins -->
                <div>
                    <label for="next_term_begins" class="block font-semibold text-gray-700 mb-1">Next Term Begins On:</label>
                    <input type="date" name="next_term_begins" id="next_term_begins"
                           value="{{ term_setting.next_term_begins|date:'Y-m-d' }}"
                           class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
                </div>

                <!-- Set as current term -->
                <div class="flex items-center gap-2">
                    <input type="checkbox" name="is_active" id="is_active" class="rounded border-gray-300" {% if term_setting.is_active %}checked{% endif %}>
                    <label for="is_active" class="font-semibold text-gray-700">Set as current term</label>
                </div>

                <!-- Submit Button -->
                <div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded shadow transition">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Dynamic Date Fetch JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const sessionSelect = document.getElementById('session');
    const termSelect = document.getElementById('term');
    const nextTermInput = document.getElementById('next_term_begins');

    async function fetchDate() {
        const session = sessionSelect.value;
        const term = termSelect.value;
        const response = await fetch(
            `/school_admin/school-admin/term-settings/?ajax=1&session=${session}&term=${term}`
        );
        if (response.ok) {
            const data = await response.json();
            nextTermInput.value = data.next_term_begins || '';
        }
    }

    sessionSelect.addEventListener('change', fetchDate);
    termSelect.addEventListener('change', fetchDate);
});
</script>
{% endblock %}
