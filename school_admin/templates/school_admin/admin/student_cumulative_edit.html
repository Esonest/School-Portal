{% load static %}
{% load custom_filters %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Cumulative Result — {{ student.user.get_full_name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    th, td { font-size: 14px; }
    @media print { button, form { display: none; } }
  </style>
</head>

<body class="bg-gray-50 p-6">
<div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">

  <form method="POST">
    {% csrf_token %}

    <!-- HEADER -->
    <div class="flex justify-between items-start mb-4">
      <div>
        {% if school.logo %}
          <img src="{{ school.logo.url }}" class="h-20 object-contain"/>
        {% endif %}
        <h1 class="text-2xl font-bold text-{{ school.theme_color }}-600">{{ school.name }}</h1>
        <p class="text-sm italic">{{ school.motto }}</p>
        <p class="text-2xl font-bold text-{{ school.theme_color }}-600">{{ school.address }}</p>
      </div>

      <div class="text-right">
        <div class="text-sm">{{ student.user.get_full_name }}</div>
        <div class="text-sm">{{ student.admission_no }}</div>
        <div class="text-sm">{{ exam_class }}</div>
        <div class="text-sm">Session: {{ selected_session }}</div>

        {% if student.photo %}
          <img src="{{ student.photo.url }}" class="h-20 w-20 rounded mt-2 border object-cover"/>
        {% endif %}
      </div>      
    </div>

    <hr class="my-4"/>

    <!-- SESSION SELECTION -->
    <div class="mb-4 flex justify-end items-center space-x-3">
      <label for="session" class="font-medium">Select Session:</label>
      <select id="session" name="session" class="border px-2 py-1" onchange="this.form.submit()">
        {% for s in available_sessions %}
          <option value="{{ s }}" {% if s == selected_session %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- CUMULATIVE TABLE -->
<div class="overflow-x-auto">
  <table class="min-w-full border text-center">
    <thead class="bg-gray-100 font-semibold">
      <tr>
        <th rowspan="2" class="border p-2">Subject</th>

        {% for term in terms %}
          <th colspan="{% if show_ca %}4{% else %}3{% endif %}" class="border p-2">{{ term }} Term</th>
        {% endfor %}

        <th rowspan="2" class="border p-2">Average</th>
        <th rowspan="2" class="border p-2">Grade</th>
        <th rowspan="2" class="border p-2">Teacher</th>
      </tr>

      <tr>
        {% for term in terms %}
          {% if show_ca %}
            <th class="border p-1">CA</th>
          {% endif %}
          <th class="border p-1">Exam</th>
          <th class="border p-1">Total</th>
          <th class="border p-1">Grade</th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for subject, data in subjects.items %}
      <tr class="border-b hover:bg-gray-50">
        <td class="border p-2 text-left font-medium">{{ subject }}</td>

        {% for term in terms %}
          {% with tdata=data|get_item:term %}
            {% if show_ca %}
              <td class="border p-2">
                <input type="number" name="ca_{{ tdata.id }}" value="{{ tdata.ca }}" class="w-16 border px-1 py-0.5 text-center"/>
              </td>
            {% endif %}
            <td class="border p-2">
              <input type="number" name="exam_{{ tdata.id }}" value="{{ tdata.exam }}" class="w-16 border px-1 py-0.5 text-center"/>
            </td>
            <td class="border p-2 font-semibold">{{ tdata.total }}</td>
            <td class="border p-2">{{ tdata.grade }}</td>
          {% endwith %}
        {% endfor %}

        <td class="border p-2 font-semibold text-blue-700">{{ data.Average|floatformat:2 }}</td>
        <td class="border p-2 font-semibold text-blue-700">{{ data.AverageGrade }}</td>
        <td class="border p-2">
          {% with tdata=data|get_item:terms.0 %}
            {{ tdata.teacher }}
          {% endwith %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


          <!-- SUMMARY ROW -->
          <tr class="bg-gray-200 font-semibold">
            <td class="border p-2 text-left">Totals & Summary</td>
            {% for term in terms %}
              <td class="border p-2" colspan="4"></td>
            {% endfor %}
            <td class="border p-2 text-blue-700">{{ avg_total|floatformat:2 }}</td>
            <td class="border p-2 text-blue-700">{{ overall_avg_grade }}</td>
            <td class="border p-2">
              <div>Total: {{ overall_total }}</div>
              <div>Best: {{ best_subject }}</div>
              <div>Weak: {{ weak_subject }}</div>
              <div>Position: {{ position }}/{{ class_size }}</div>
            </td>
          </tr>

        </tbody>
      </table>
    </div>

    <!-- PSYCHOMOTOR AND AFFECTIVE -->
    <div class="grid grid-cols-2 gap-6 mt-6">
      <div>
        <h3 class="font-semibold text-lg">Psychomotor</h3>
        <ul class="list-disc ml-5 text-md">
          {% for skill, value in psychomotor.items %}
            <li>{{ skill|capfirst }}:
              {% for i in "12345"|make_list %}
                <label>
                  <input type="radio" name="{{ skill }}" value="{{ i }}" {% if value|add:0 >= i|add:0 %}checked{% endif %} class="hidden"/>
                  {% if value|add:0 >= i|add:0 %}⭐{% else %}☆{% endif %}
                </label>
              {% endfor %}
            </li>
          {% endfor %}
        </ul>
      </div>

      <div>
        <h3 class="font-semibold text-lg">Affective</h3>
        <ul class="list-disc ml-5 text-md">
          {% for skill, value in affective.items %}
            <li>{{ skill|capfirst }}:
              {% for i in "12345"|make_list %}
                <label>
                  <input type="radio" name="{{ skill }}" value="{{ i }}" {% if value|add:0 >= i|add:0 %}checked{% endif %} class="hidden"/>
                  {% if value|add:0 >= i|add:0 %}⭐{% else %}☆{% endif %}
                </label>
              {% endfor %}
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- COMMENTS -->
<div class="mt-6 space-y-4">
    
    <!-- Principal Comment -->
    <div>
        <h3 class="font-semibold">Principal's Comment</h3>
        <textarea 
            name="principal_comment"
            class="w-full border rounded p-2 min-h-[90px]"
        >{{ principal_comment|default_if_none:"" }}
        {% for p in promotion_history %}
    {{ p.session }}: PROMOTED FROM 
    {{ p.old_class }} TO {{ p.new_class }}
    ({{ p.promoted_on|date:"M d, Y" }})
{% empty %}
  No promotion history recorded.
{% endfor %}
    
      </textarea>
    <!-- Teacher Comment -->
    <div>
        <h3 class="font-semibold">Teacher's Comment</h3>
        <textarea 
            name="teacher_comment"
            class="w-full border rounded p-2 min-h-[90px]"
        >{{ teacher_comment|default_if_none:"" }}</textarea>
    </div>

</div>

<!-- NEXT TERM INFORMATION -->
<div class="mt-4 border border-black p-2 text-sm">
  <p class="text-xl font-bold text-{{ school.theme_color }}-600">
    <strong>Next Term Begins On:</strong>
    <span class="ml-1">{{ next_term_begins|date:"l, jS F Y"|default:"________________" }}</span>
  </p>
</div>
    <!-- SIGNATURE + QR -->
    <div class="mt-6 flex justify-between">
      <div>
        {% if principal_signature_url %}
          <img src="{{ principal_signature_url }}" class="h-16"/>
        {% else %}
          <div class="text-sm text-gray-500">Principal's signature</div>
        {% endif %}
      </div>

      <div class="text-right">
        <img src="{{ qr_data_uri }}" class="h-20 w-20 border bg-white p-1"/>
        <div class="text-xs text-gray-500">Scan to verify</div>
      </div>
    </div>

    <!-- SAVE & PRINT BUTTONS -->
    <div class="mt-6 flex space-x-2">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded shadow">
        Save Changes
      </button>
      <button type="button" onclick="window.print()" class="bg-green-600 text-white px-4 py-2 rounded shadow">
        Print
      </button>
    </div>
  </form>
</div>
</body>
</html>
