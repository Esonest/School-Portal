{% extends 'accounts/base.html' %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<div class="max-w-6xl mx-auto p-6">
  {% if messages %}
    <div class="mb-4 space-y-2">
      {% for message in messages %}
        <div class="p-3 rounded {{ message.tags|default:'bg-green-50 border-green-400 text-green-800' }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Top Bar: Class + Term Selector -->
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-semibold text-{{ school.theme_color }}-600">Bulk Psychomotor & Affective — {{ selected_class.name }}</h1>
    <form method="get" class="flex gap-3 items-end">
      <input type="hidden" name="page" value="{{ page_obj.number }}">

      <!-- SESSION selector -->
<select name="session" onchange="this.form.submit()" class="px-3 py-2 border rounded">
  <option value="">-- Select session --</option>
  {% for ses in session_choices %}
    <option value="{{ ses }}" {% if selected_session == ses %}selected{% endif %}>
      {{ ses }}
    </option>
  {% endfor %}
</select>

      <!-- Class Selector -->
      <select name="class_id" onchange="this.form.submit()" class="px-3 py-2 border rounded">
        {% for cls in classes %}
          <option value="{{ cls.id }}" {% if selected_class and selected_class.id == cls.id %}selected{% endif %}>{{ cls.name }}</option>
        {% endfor %}
      </select>

      <!-- Term Selector -->
      <select name="term" onchange="this.form.submit()" class="px-3 py-2 border rounded">
        {% for key, value in term_choices.items %}
          <option value="{{ key }}" {% if selected_term == key %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
      </select>
    </form>
  </div>

  <form method="post" id="bulk-psy-aff-form">
    {% csrf_token %}
    <input type="hidden" name="class_id" value="{{ selected_class.id }}">
    <input type="hidden" name="term" value="{{ selected_term }}">

    <!-- Psychomotor Section -->
    <div class="bg-white shadow rounded mb-6 overflow-x-auto">
      <div class="p-4 border-b">
        <h2 class="text-lg font-semibold">Psychomotor Ratings</h2>
        <p class="text-sm text-gray-500">Rate 1–5 stars (click a star to choose rating)</p>
      </div>
      <table class="w-full table-auto">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-3 text-left">#</th>
            <th class="p-3 text-left">Student</th>
            <th class="p-3 text-center">Neatness</th>
            <th class="p-3 text-center">Agility</th>
            <th class="p-3 text-center">Creativity</th>
            <th class="p-3 text-center">Sports</th>
            <th class="p-3 text-center">Handwriting</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr class="border-b">
              <td class="p-3 text-sm text-gray-700">{{ forloop.counter0|add:page_obj.start_index }}</td>
              <td class="p-3">
                <div class="font-medium">{{ r.student.full_name }}</div>
                <div class="text-sm text-gray-500">{{ r.student.school_class.name }}</div>
                {{ r.psy_form.student }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.psy_prefix }}-neatness" data-tooltip="Neatness">
                  {% for i in "12345" %}
                    <button type="button" class="psy-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.psy_form.neatness }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.psy_prefix }}-agility" data-tooltip="Agility">
                  {% for i in "12345" %}
                    <button type="button" class="psy-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.psy_form.agility }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.psy_prefix }}-creativity" data-tooltip="Creativity">
                  {% for i in "12345" %}
                    <button type="button" class="psy-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.psy_form.creativity }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.psy_prefix }}-sports" data-tooltip="Sports">
                  {% for i in "12345" %}
                    <button type="button" class="psy-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.psy_form.sports }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.psy_prefix }}-handwriting" data-tooltip="Handwriting">
                  {% for i in "12345" %}
                    <button type="button" class="psy-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.psy_form.handwriting }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Affective Section -->
    <div class="bg-white shadow rounded mb-6 overflow-x-auto">
      <div class="p-4 border-b">
        <h2 class="text-lg font-semibold">Affective Ratings</h2>
        <p class="text-sm text-gray-500">Rate 1–5 stars (click a star to choose rating)</p>
      </div>

      <table class="w-full table-auto">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-3 text-left">#</th>
            <th class="p-3 text-left">Student</th>
            <th class="p-3 text-center">Punctuality</th>
            <th class="p-3 text-center">Cooperation</th>
            <th class="p-3 text-center">Behavior</th>
            <th class="p-3 text-center">Attentiveness</th>
            <th class="p-3 text-center">Perseverance</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr class="border-b">
              <td class="p-3 text-sm text-gray-700">{{ forloop.counter0|add:page_obj.start_index }}</td>
              <td class="p-3">
                <div class="font-medium">{{ r.student.full_name }}</div>
                <div class="text-sm text-gray-500">{{ r.student.school_class.name }}</div>
                {{ r.aff_form.student }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.aff_prefix }}-punctuality" data-tooltip="Punctuality">
                  {% for i in "12345" %}
                    <button type="button" class="aff-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.aff_form.punctuality }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.aff_prefix }}-cooperation" data-tooltip="Cooperation">
                  {% for i in "12345" %}
                    <button type="button" class="aff-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.aff_form.cooperation }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.aff_prefix }}-behavior" data-tooltip="Behavior">
                  {% for i in "12345" %}
                    <button type="button" class="aff-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.aff_form.behavior }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.aff_prefix }}-attentiveness" data-tooltip="Attentiveness">
                  {% for i in "12345" %}
                    <button type="button" class="aff-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.aff_form.attentiveness }}
              </td>

              <td class="p-3 text-center">
                <div class="inline-flex gap-1 justify-center" data-input-name="{{ r.aff_prefix }}-perseverance" data-tooltip="Perseverance">
                  {% for i in "12345" %}
                    <button type="button" class="aff-star star-btn px-1 text-2xl" data-value="{{ forloop.counter }}">☆</button>
                  {% endfor %}
                </div>
                {{ r.aff_form.perseverance }}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Buttons + Pagination -->
    <div class="flex justify-between items-center mt-4 p-4">
      <div>
        <button type="submit" name="save" class="bg-yellow-500 text-white px-4 py-2 rounded mr-2">Save & Continue Later</button>
        <button type="submit" name="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Submit All</button>
      </div>

      <div class="flex items-center gap-3">
        <span>Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
        <div class="flex items-center gap-1">
          {% if page_obj.has_previous %}
            <a href="?class_id={{ selected_class.id }}&term={{ selected_term }}&page={{ page_obj.previous_page_number }}" class="px-2 py-1 border rounded">Previous</a>
          {% endif %}
          {% if page_obj.has_next %}
            <a href="?class_id={{ selected_class.id }}&term={{ selected_term }}&page={{ page_obj.next_page_number }}" class="px-2 py-1 border rounded">Next</a>
          {% endif %}
        </div>
      </div>
    </div>
  </form>
</div>

<!-- JS: progressive star fill + sync to hidden inputs + tooltips -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const labelMap = ['Poor','Fair','Good','Very good','Excellent'];

  function setStars(group, value) {
    const buttons = Array.from(group.querySelectorAll('.star-btn'));
    buttons.forEach((btn, idx) => btn.textContent = (idx < value) ? '⭐' : '☆');
  }

  function initGroup(group) {
    const inputName = group.getAttribute('data-input-name');
    const hiddenInput = document.querySelector(`input[name="${inputName}"]`);
    let initial = hiddenInput ? parseInt(hiddenInput.value || '0', 10) : 0;
    setStars(group, initial);

    group.querySelectorAll('.star-btn').forEach((btn, idx) => {
      btn.addEventListener('click', function () {
        const val = parseInt(this.getAttribute('data-value'), 10);
        setStars(group, val);
        if (hiddenInput) hiddenInput.value = val;
      });
      btn.addEventListener('mouseenter', function () {
        btn.setAttribute('title', `${labelMap[idx]} (${idx+1}) — ${group.getAttribute('data-tooltip') || ''}`);
      });
    });
  }

  document.querySelectorAll('[data-input-name]').forEach(initGroup);
});
</script>
{% endblock %}
