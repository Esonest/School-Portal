{% load custom_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Result — {{ student.user.get_full_name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @page { size: A4; margin: 15mm; }
    body { font-size: 12px; }
    th, td { font-size: 12px; }
    @media print {
      .no-print { display: none !important; }
      .print-watermark { opacity: 0.1 !important; }
    }
    .result-watermark {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 0;
    }
    .result-watermark img {
      max-width: 50%;
      opacity: 0.1;
    }
    .result-container { position: relative; z-index: 1; max-width: 210mm; margin: auto; border: 2px solid #000; background: #fff; padding: 16px; }
  </style>
</head>
<body class="bg-gray-100 p-0">

{% if school_logo_url %}
  <div class="result-watermark">
    <img src="{{ school_logo_url }}" alt="School Logo Watermark" />
  </div>
{% endif %}

<div class="result-container">

  <!-- HEADER -->
  <div class="flex justify-between items-start border-b border-black pb-2 mb-3">
    <div>
      {% if school_logo_url %}
        <img src="{{ school_logo_url }}" alt="{{ school.name }} Logo" class="h-16">
      {% else %}
        <div class="text-gray-400 text-sm">School Logo</div>
      {% endif %}
      <h1 class="text-2xl font-bold text-{{ school.theme_color }}-600">{{ school.name }}</h1>
      <p class="text-sm italic">{{ school.motto }}</p>
      <p class="text-xs text-gray-500">{{ school.address }}</p>
    </div>

    <div class="text-right">
      <p class="text-sm"><strong>Name:</strong> {{ student.user.get_full_name }}</p>
      <p class="text-sm"><strong>Admission No:</strong> {{ student.admission_no }}</p>
      <p class="text-sm"><strong>Class:</strong> {{ student.school_class.name }}</p>
      {% if is_cumulative or selected_term == "cumulative" %}
        <p class="text-sm"><strong>Cumulative Result</strong> • Session: {{ selected_session }}</p>
      {% else %}
        <p class="text-sm"><strong>Term:</strong> {{ selected_term }} • <strong>Session:</strong> {{ selected_session }}</p>
      {% endif %}
      {% if student.photo %}
        <img src="{{ student.photo.url }}" alt="Photo" class="h-20 w-20 rounded object-cover mt-2 border">
      {% endif %}
    </div>
  </div>

  <!-- VERIFIED STATUS -->
  {% if status == "verified" %}
    <div class="mb-3 text-right">
      <span class="inline-flex items-center px-4 py-1.5 rounded-full bg-green-100 text-green-800 text-sm font-semibold border border-green-300">
        ✅ Verified Result
      </span>
    </div>
  {% endif %}

  <!-- ACADEMIC PERFORMANCE TABLE -->
  {% if is_cumulative or selected_term == "cumulative" %}
    <h2 class="font-semibold uppercase text-center border border-black py-1 bg-gray-200">Cumulative Academic Performance</h2>
    <div class="overflow-x-auto mt-2">
      <table class="w-full border border-black border-collapse text-center">
        <thead class="bg-gray-100 font-semibold">
          <tr>
            <th rowspan="2" class="border border-black p-2 text-left">Subject</th>
            {% for term in terms %}
              <th colspan="{% if show_ca %}4{% else %}3{% endif %}" class="border border-black p-2">{{ term }} Term</th>
            {% endfor %}
            <th rowspan="2" class="border border-black p-2">Average</th>
            <th rowspan="2" class="border border-black p-2">Grade</th>
            <th rowspan="2" class="border border-black p-2">Teacher</th>
          </tr>
          <tr>
            {% for term in terms %}
              {% if show_ca %}<th class="border border-black p-1">CA</th>{% endif %}
              <th class="border border-black p-1">Exam</th>
              <th class="border border-black p-1">Total</th>
              <th class="border border-black p-1">Grade</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for subject, data in subjects.items %}
          <tr class="border-b hover:bg-gray-50">
            <td class="border border-black p-2 text-left font-medium">{{ subject }}</td>
            {% for term in terms %}
              {% with tdata=data|get_item:term %}
                {% if show_ca %}<td class="border border-black p-2">{{ tdata.ca|default:"0" }}</td>{% endif %}
                <td class="border border-black p-2">{{ tdata.exam }}</td>
                <td class="border border-black p-2 font-semibold">{{ tdata.total }}</td>
                <td class="border border-black p-2">{{ tdata.grade }}</td>
              {% endwith %}
            {% endfor %}
            <td class="border border-black p-2 font-semibold text-blue-700">{{ data.Average|floatformat:2 }}</td>
            <td class="border border-black p-2 font-semibold text-blue-700">{{ data.AverageGrade }}</td>
            <td class="border border-black p-2">
              {% with tdata=data|get_item:terms.0 %}{{ tdata.teacher }}{% endwith %}
            </td>
          </tr>
          {% endfor %}
          <!-- TOTALS ROW -->
          <tr class="bg-gray-200 font-semibold">
            <td class="border border-black p-2 text-left">Totals & Summary</td>
            {% for term in terms %}
              <td class="border border-black p-2" colspan="{% if show_ca %}4{% else %}3{% endif %}"></td>
            {% endfor %}
            <td class="border border-black p-2 text-blue-700">{{ avg_total|floatformat:2 }}</td>
            <td class="border border-black p-2 text-blue-700">{{ overall_avg_grade }}</td>
            <td class="border border-black p-2">
              <div>Total: {{ overall_total }}</div>
              <div>Best: {{ best_subject }}</div>
              <div>Weak: {{ weak_subject }}</div>
              <div>Position: {{ position }}/{{ class_size }}</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  {% else %}
    <!-- TERM RESULT TABLE -->
    <h2 class="font-semibold uppercase text-center border border-black py-1 bg-gray-200">Academic Performance</h2>
    <div class="overflow-x-auto mt-2">
      <table class="w-full border border-black border-collapse text-center">
        <thead class="bg-gray-100 font-semibold">
          <tr>
            <th class="border border-black p-2 text-left">Subject</th>
            {% if class_has_ca %}<th class="border border-black p-2">CA</th>{% endif %}
            <th class="border border-black p-2">Exam</th>
            <th class="border border-black p-2">Total</th>
            <th class="border border-black p-2">Class Avg</th>
            <th class="border border-black p-2">Grade</th>
            <th class="border border-black p-2">Grade Interpretation</th>
            <th class="border border-black p-2">Teacher</th>
          </tr>
        </thead>
        <tbody>
          {% for s in scores %}
          <tr class="border-b hover:bg-gray-50">
            <td class="border border-black p-2 text-left">{{ s.subject }}</td>
            {% if class_has_ca %}<td class="border border-black p-2">{{ s.ca|default:"0" }}</td>{% endif %}
            <td class="border border-black p-2">{{ s.exam }}</td>
            <td class="border border-black p-2 font-semibold">{{ s.total }}</td>
            <td class="border border-black p-2 font-semibold">{{ s.class_average }}</td>
            <td class="border border-black p-2">{{ s.grade }}</td>
            <td class="border border-black p-2">{{ s.grade_interpretation }}</td>
            <td class="border border-black p-2">{{ s.teacher }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="{% if class_has_ca %}8{% else %}7{% endif %}" class="border border-black p-2 text-gray-500">No scores available</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

  <!-- PSYCHOMOTOR AND AFFECTIVE -->
  <div class="mt-4 grid md:grid-cols-2 gap-6">
    <!-- Psychomotor -->
    <div class="bg-blue-50 p-4 rounded shadow-sm border border-black">
      <h3 class="font-semibold mb-3 text-blue-700">Psychomotor Domain</h3>
      {% if psychomotor %}
      <ul class="space-y-1">
        {% for attr, value in psychomotor.items %}
        <li class="flex justify-between">
          <span>{{ attr|capfirst }}</span>
          <span class="text-yellow-600">
            {% for i in "12345" %}{% if i|add:"0" <= value %}★{% else %}☆{% endif %}{% endfor %}
          </span>
        </li>
        {% endfor %}
      </ul>
      {% else %}<p class="text-gray-500">Not recorded</p>{% endif %}
    </div>

    <!-- Affective -->
    <div class="bg-green-50 p-4 rounded shadow-sm border border-black">
      <h3 class="font-semibold mb-3 text-green-700">Affective Domain</h3>
      {% if affective %}
      <ul class="space-y-1">
        {% for attr, value in affective.items %}
        <li class="flex justify-between">
          <span>{{ attr|capfirst }}</span>
          <span class="text-yellow-600">
            {% for i in "12345" %}{% if i|add:"0" <= value %}★{% else %}☆{% endif %}{% endfor %}
          </span>
        </li>
        {% endfor %}
      </ul>
      {% else %}<p class="text-gray-500">Not recorded</p>{% endif %}
    </div>
  </div>

  <!-- COMMENTS -->
  <div class="mt-6 border border-black p-3">
    <h3 class="font-semibold">Principal's Comment</h3>
    <p class="italic">{{ principal_comment }}</p>
    <h3 class="font-semibold mt-3">Teacher's Comment</h3>
    <p class="italic">{{ teacher_comment }}</p>
  </div>

  <!-- SIGNATURE AND QR -->
  <div class="mt-6 flex justify-between items-center">
    <div class="flex items-center space-x-4">
      {% if principal_signature_url %}
        <img src="{{ principal_signature_url }}" alt="Principal's Signature" class="h-16 w-32 object-contain border rounded"/>
      {% else %}
        <div class="h-16 w-32 border rounded flex items-center justify-center text-xs text-gray-500">Principal's Signature</div>
      {% endif %}
      <div class="text-sm font-medium">Principal</div>
    </div>

    <div class="text-right">
      <img src="{{ qr_data_uri }}" alt="Verification QR Code" class="h-20 w-20 border bg-white p-1"/>
      <div class="text-xs text-gray-500">Scan to verify</div>
    </div>
  </div>

  <!-- PRINT BUTTON -->
  <div class="mt-4 no-print text-right">
    <button onclick="window.print()" class="px-4 py-2 bg-green-600 text-white rounded">Print</button>
  </div>

</div>
</body>
</html>
