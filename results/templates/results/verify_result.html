{% load custom_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Result — {{ student.user.get_full_name }}</title>

<style>
@page { size: A4; margin: 12mm; }

body {
  font-family: "Times New Roman", serif;
  font-size: 11px;
  margin: 0;
  background: #fff;
}

/* ================= CONTAINER ================= */
.result-container {
  width: 190mm;
  min-height: 277mm;
  margin: auto;
  padding: 8mm;
  border: 2px solid #000;
  position: relative;
}

/* ================= HEADER ================= */
.school-header {
  text-align: center;
  border-bottom: 2px solid #000;
  padding-bottom: 6px;
  margin-bottom: 8px;
}

.school-header h1 {
  font-size: 18px;
  margin: 0;
  font-weight: bold;
  text-transform: uppercase;
}

/* ================= BIO DATA ================= */
.bio-grid {
  display: grid;
  grid-template-columns: 1fr 120px;
  gap: 8px;
  border: 1px solid #000;
  padding: 6px;
  margin-bottom: 8px;
}

.bio-table td {
  padding: 2px 4px;
}

.passport {
  border: 1px solid #000;
  height: 120px;
  width: 100px;
  object-fit: cover;
}

/* ================= TABLE ================= */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 10.5px;
}

th, td {
  border: 1px solid #000;
  padding: 3px;
  text-align: center;
}

/* ================= SUMMARY + DOMAIN ================= */
.summary-domain {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  border: 1px solid #000;
  padding: 6px;
  margin-top: 6px;
}

.domain-box h3 {
  text-align: center;
  border-bottom: 1px solid #000;
  font-size: 11px;
}

.domain-box li {
  display: flex;
  justify-content: space-between;
  font-size: 10.5px;
}

/* ================= STARS ================= */
.star .filled { color: #b8860b; font-weight: bold; }
.star .empty { color: #000; }

/* ================= LEGEND ================= */
.legend-box {
  margin-top: 6px;
  border: 1px solid #000;
  padding: 6px;
  font-size: 10.5px;
  width: fit-content;
}

/* ================= SIGNATURE ================= */
.signatures {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  align-items: flex-end;
}

/* ================= PROMOTION HISTORY ================= */
.promotion-box {
  margin-top: 6px;
  border: 1px solid #000;
  padding: 6px;
  font-size: 10.5px;
}

.promotion-box p {
  margin: 2px 0;
}


.sign-box { text-align: center; font-size: 10.5px; }

@media print { .no-print { display: none; } }
</style>
</head>

<body>
<div class="result-container">

<!-- HEADER -->
<div class="school-header">
  <h1 class="text-2xl font-bold text-{{ school.theme_color }}-600">{{ school.name }}</h1>
  <p class="text-xs">{{ school.address }}</p>
  <p class="italic text-sm"><strong>{{ school.motto }}</strong></p>
  <p>
    {% if is_cumulative %}CUMULATIVE RESULT{% else %}TERMINAL RESULT{% endif %}
    — {{ selected_session }}
  </p>
</div>

<!-- BIO DATA -->
<div class="bio-grid">
  <table class="bio-table">
    <tr><td><strong>Name:</strong></td><td>{{ student.user.get_full_name }}</td></tr>
    <tr><td><strong>Admission No:</strong></td><td>{{ student.admission_no }}</td></tr>
    <tr><td><strong>Class:</strong></td><td>{{ exam_class }}</td></tr>
    <tr><td><strong>Term:</strong></td><td>{{ selected_term }}</td></tr>
    <tr><td><strong>Position:</strong></td><td>{{ position }} of {{ class_size }}</td></tr>
  </table>
  {% if student_photo_url %}
    <img src="{{ student_photo_url }}" class="passport">
  {% endif %}
</div>

<!-- ACADEMIC TABLE (UNCHANGED LOGIC) -->
<h3>Academic Performance</h3>
<table>
  <!-- YOUR EXISTING TABLE LOGIC REMAINS EXACTLY THE SAME -->
  {{ block.super }}
</table>

<!-- SUMMARY + DOMAIN -->
<div class="summary-domain">

  <div>
    <p><strong>Total:</strong> {{ overall_total }}</p>
    <p><strong>Average:</strong> {{ avg_total|floatformat:2 }}</p>
    <p><strong>Best Subject:</strong> {{ best_subject }}</p>
    <p><strong>Weakest Subject:</strong> {{ weak_subject }}</p>
  </div>

  <div class="domain-box">
    <h3>PSYCHOMOTOR</h3>
    {% for attr in "neatness,agility,creativity,handwriting,sports"|split:"," %}
    <li>
      {{ attr|capfirst }}
      <span class="star">
        {% for i in "12345" %}
          {% if i|add:"0" <= psychomotor|get_attr:attr %}
            <span class="filled">★</span>
          {% else %}
            <span class="empty">☆</span>
          {% endif %}
        {% endfor %}
      </span>
    </li>
    {% endfor %}

    <h3>AFFECTIVE</h3>
    {% for attr in "punctuality,cooperation,behavior,attentiveness,perseverance"|split:"," %}
    <li>
      {{ attr|capfirst }}
      <span class="star">
        {% for i in "12345" %}
          {% if i|add:"0" <= affective|get_attr:attr %}
            <span class="filled">★</span>
          {% else %}
            <span class="empty">☆</span>
          {% endif %}
        {% endfor %}
      </span>
    </li>
    {% endfor %}
  </div>

</div>

<!-- LEGEND -->
<div class="legend-box">
  ★★★★★ = Excellent |
  ★★★★☆ = Very Good |
  ★★★☆☆ = Good |
  ★★☆☆☆ = Fair |
  ★☆☆☆☆ = Poor
</div>

<!-- COMMENTS -->
<div class="comment-box">
  <p><strong>Principal’s Comment:</strong> {{ principal_comment }}</p>

  {% if promotion_history %}
    <div class="promotion-box">
      <p><strong>PROMOTION HISTORY</strong></p>
      {% for p in promotion_history %}
        <p class="text-green-600 font-bold">
          {{ p.session }}:
          PROMOTED FROM {{ p.old_class }}
          TO {{ p.new_class }}
          ({{ p.promoted_on|date:"M d, Y" }})
        </p>
      {% endfor %}
    </div>
  {% endif %}

  <p style="margin-top:4px;">
    <strong>Teacher’s Comment:</strong> {{ teacher_comment }}
  </p>
</div>

<!-- SIGNATURE -->
<div class="signatures">
  <div class="sign-box">
    {% if principal_signature_url %}<img src="{{ principal_signature_url }}" height="40">{% endif %}
    <div>Principal</div>
  </div>
  <div class="sign-box">
    <img src="{{ qr_data_uri }}" height="60">
    <div>Verification QR</div>
  </div>
</div>

</div>
</body>
</html>
