{% extends "accounts/base.html" %}
{% load static %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 py-8">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-2">
    <h2 class="text-3xl font-bold text-gray-800">ðŸ“Š Financial Report</h2>
    <p class="text-2xl font-bold text-{{ school.theme_color }}-600">
      {{ school.name }} â€” {{ selected_session|default:"All Sessions" }} / Term {{ selected_term|default:"All Terms" }}
    </p>
  </div>

  <!-- Filters -->
  <form method="get" class="bg-white rounded-2xl shadow p-6 mb-8">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">

      <!-- Class -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Class</label>
        <select name="school_class" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-400">
          <option value="">All Classes</option>
          {% for cls in classes %}
            <option value="{{ cls.id }}" {% if cls.id|stringformat:"s" == selected_class %}selected{% endif %}>
              {{ cls.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Session -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Session</label>
        <select name="session" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-400">
          <option value="">All Sessions</option>
          {% for s in sessions %}
            <option value="{{ s }}" {% if s == selected_session %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Term -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Term</label>
        <select name="term" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-indigo-400">
          <option value="">All Terms</option>
          {% for key, value in terms %}
            <option value="{{ key }}" {% if key == selected_term %}selected{% endif %}>{{ value }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Button -->
      <div class="flex items-end">
        <button type="submit"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">
          Apply Filter
        </button>
      </div>

    </div>
  </form>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl p-6 shadow">
      <p class="text-sm opacity-90">Total Invoiced</p>
      <h3 class="text-2xl font-bold mt-2">â‚¦{{ total_invoiced|floatformat:2 }}</h3>
    </div>
    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-2xl p-6 shadow">
      <p class="text-sm opacity-90">Total Paid</p>
      <h3 class="text-2xl font-bold mt-2">â‚¦{{ total_paid|floatformat:2 }}</h3>
    </div>
    <div class="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-2xl p-6 shadow">
      <p class="text-sm opacity-90">Outstanding</p>
      <h3 class="text-2xl font-bold mt-2">â‚¦{{ total_balance|floatformat:2 }}</h3>
    </div>
    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-2xl p-6 shadow">
      <p class="text-sm opacity-90">Invoices Count</p>
      <h3 class="text-2xl font-bold mt-2">{{ invoices|length }}</h3>
    </div>
  </div>

  <!-- Invoices Table -->
  <div class="bg-white rounded-2xl shadow overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Student</th>
          <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Class</th>
          <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Invoice</th>
          <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Total</th>
          <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Paid</th>
          <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Balance</th>
          <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Term</th>
          <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for invoice in invoices %}
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4">{{ invoice.student }}</td>
          <td class="px-6 py-4">{{ invoice.school_class }}</td>
          <td class="px-6 py-4">{{ invoice.title }}</td>
          <td class="px-6 py-4 font-semibold">â‚¦{{ invoice.total_amount|floatformat:2 }}</td>
          <td class="px-6 py-4 font-semibold text-green-600">â‚¦{{ invoice.amount_paid|floatformat:2 }}</td>
          <td class="px-6 py-4 font-semibold text-red-600">â‚¦{{ invoice.balance|floatformat:2 }}</td>
          <td class="px-6 py-4">{{ invoice.get_term_display }}</td>
          <td class="px-6 py-4">
            <button
              class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-1 rounded-lg"
              @click="showReceipt({{ invoice.id }})">
              View Receipts
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="px-6 py-10 text-center text-gray-500">
            No invoices found for selected filters.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- Receipt Modal (Single Modal) -->
<div x-data="receiptModal()" x-show="show" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display:none;">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-3xl p-6 relative">
    <button @click="close()" class="absolute top-3 right-3 text-gray-600 font-bold text-lg">âœ–</button>
    <h3 class="text-xl font-bold mb-4">ðŸ’³ Payment History - <span x-text="studentName"></span></h3>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase">Invoice</th>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase">Amount</th>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase">Method</th>
            <th class="px-4 py-2 text-left text-xs font-bold text-gray-600 uppercase">Date</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="p in payments" :key="p.id">
            <tr>
              <td class="px-4 py-2" x-text="p.title"></td>
              <td class="px-4 py-2" x-text="p.amount"></td>
              <td class="px-4 py-2" x-text="p.method"></td>
              <td class="px-4 py-2" x-text="p.date"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button @click="print()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Print</button>
      <button @click="close()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">Close</button>
    </div>
  </div>
</div>

<script>
function receiptModal() {
    return {
        show: false,
        studentName: '',
        payments: [],
        showReceipt(invoiceId) {
            fetch(`/finance/invoice/${invoiceId}/payments/`) // create this view to return JSON payments
              .then(res => res.json())
              .then(data => {
                  this.studentName = data.student;
                  this.payments = data.payments;
                  this.show = true;
                  document.body.style.overflow = 'hidden';
              });
        },
        close() {
            this.show = false;
            this.studentName = '';
            this.payments = [];
            document.body.style.overflow = 'auto';
        },
        print() {
            const printWindow = window.open('', '', 'width=900,height=600');
            printWindow.document.write('<html><head><title>Payment History</title>');
            printWindow.document.write('<link rel="stylesheet" href="{% static "css/tailwind.css" %}">');
            printWindow.document.write('</head><body>');
            printWindow.document.write(document.querySelector('[x-show="show"] .overflow-x-auto').innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
    }
}
</script>

{% endblock %}
