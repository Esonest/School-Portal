{% extends "finance/base_finance.html" %}
{% block title %}Invoices{% endblock %}

{% block actions %}
<a href="{% url 'finance:invoice_create' %}"
   class="px-4 py-2 bg-indigo-600 text-white rounded">
   + New Invoice
</a>
{% endblock %}

{% block body %}

<!-- MOBILE STACKED INVOICES WITH INLINE PAY NOW -->
<div class="space-y-4 md:hidden">

  {% for invoice in invoices %}
  <div class="bg-white shadow rounded-lg p-4 border">

    <!-- Header -->
    <div class="flex justify-between items-start">
      <div>
        <p class="font-semibold">{{ invoice.student }}</p>
        <p class="text-xs text-gray-500">
          {{ invoice.school_class }} · {{ invoice.session }} · {{ invoice.get_term_display }}
        </p>
      </div>

      {% if invoice.amount_paid >= invoice.total_amount %}
        <span class="text-xs font-semibold text-green-600">Paid</span>
      {% elif invoice.amount_paid > 0 %}
        <span class="text-xs font-semibold text-yellow-600">Partial</span>
      {% else %}
        <span class="text-xs font-semibold text-red-600">Unpaid</span>
      {% endif %}
    </div>

    <!-- Amounts -->
    <div class="grid grid-cols-2 gap-3 mt-4 text-sm">
      <div>
        <p class="text-gray-500 text-xs">Amount</p>
        <p class="font-semibold">₦{{ invoice.total_amount|floatformat:2 }}</p>
      </div>
      <div>
        <p class="text-gray-500 text-xs">Paid</p>
        <p class="font-semibold">₦{{ invoice.amount_paid|floatformat:2 }}</p>
      </div>
    </div>

    <!-- Payment / Receipt -->
    <div class="mt-3 text-sm flex items-center gap-2">
      {% if invoice.successful_transactions %}
        {% with tx=invoice.successful_transactions.0 %}
          <span class="text-green-600 text-xs font-semibold">Paystack</span>
          <a href="https://dashboard.paystack.com/receipts/{{ tx.paystack_reference }}"
             target="_blank"
             class="ml-1 text-green-600 underline text-xs">
             Receipt
          </a>
        {% endwith %}
      {% else %}
        <span class="text-gray-400 text-xs">—</span>
      {% endif %}
    </div>

    <!-- ACTIONS -->
    <div class="mt-4 flex flex-col sm:flex-row gap-3">
      <a href="{% url 'finance:invoice_update' invoice.id %}"
         class="flex-1 text-center bg-green-600 text-white py-2 rounded text-sm font-semibold">
         Edit
      </a>

      <a href="{% url 'finance:invoice_delete' invoice.id %}"
         class="flex-1 text-center bg-red-600 text-white py-2 rounded text-sm font-semibold">
         Delete
      </a>

      {% if invoice.amount_paid < invoice.total_amount %}
      <!-- INLINE PAY NOW -->
      <form action="{% url 'finance:pay_invoice' invoice.id %}" method="post" class="flex-1">
        {% csrf_token %}
        <input type="hidden" name="amount" value="{{ invoice.total_amount|floatformat:2|floatformat:0|add:'0' }}">
        <button type="submit"
                class="w-full bg-indigo-600 text-white py-2 rounded text-sm font-semibold hover:bg-indigo-700">
          Pay Now
        </button>
      </form>
      {% endif %}
    </div>

  </div>
  {% empty %}
  <p class="text-center text-gray-500 text-sm py-6">No invoices found</p>
  {% endfor %}

</div>

<!-- ================= DESKTOP TABLE ================= -->
<div class="hidden md:block bg-white shadow rounded overflow-x-auto">

  <table class="w-full text-sm border-collapse">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-3 text-left">Student</th>
        <th class="p-3 text-left">Class</th>
        <th class="p-3 text-right">Amount</th>
        <th class="p-3 text-right">Paid</th>
        <th class="p-3 text-left">Session</th>
        <th class="p-3 text-left">Term</th>
        <th class="p-3 text-left">Payment</th>
        <th class="p-3 text-right">Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for invoice in invoices %}
      <tr class="border-t hover:bg-gray-50">

        <td class="p-3">{{ invoice.student }}</td>
        <td class="p-3">{{ invoice.school_class }}</td>

        <td class="p-3 text-right">
          ₦{{ invoice.total_amount|floatformat:2 }}
        </td>

        <td class="p-3 text-right">
          ₦{{ invoice.amount_paid|floatformat:2 }}
        </td>

        <td class="p-3">{{ invoice.session }}</td>
        <td class="p-3">{{ invoice.get_term_display }}</td>

        <!-- Payment -->
        <td class="p-3">
          {% if invoice.successful_transactions %}
            {% with tx=invoice.successful_transactions.0 %}
              <span class="text-green-600 text-xs font-semibold">Paystack</span>
              <a href="https://dashboard.paystack.com/receipts/{{ tx.paystack_reference }}"
                 target="_blank"
                 class="ml-1 text-green-600 underline text-xs">
                 Receipt
              </a>
            {% endwith %}
          {% else %}
            <span class="text-gray-400 text-xs">—</span>
          {% endif %}
        </td>

        <!-- Actions -->
        <td class="p-3 text-right space-x-2">
          <a href="{% url 'finance:invoice_update' invoice.id %}"
             class="text-green-600 hover:underline">
             Edit
          </a>
          <a href="{% url 'finance:invoice_delete' invoice.id %}"
             class="text-red-600 hover:underline">
             Delete
          </a>
        </td>

      </tr>
      {% empty %}
      <tr>
        <td colspan="8" class="p-6 text-center text-gray-500">
          No records found
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>

{% endblock %}
