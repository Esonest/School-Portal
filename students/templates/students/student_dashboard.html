{% extends 'accounts/base.html' %}
{% block content %}

<style>
  :root {
    --theme: #4f46e5;
    --theme-light: #eef2ff;
    --bg-dark: #020617;
    --card-dark: #020617;
    --border-dark: #1e293b;
    --text-muted-dark: #94a3b8;
  }

  /* üåô DARK MODE */
  body.dark,
  @media (prefers-color-scheme: dark) {
    body {
      background: var(--bg-dark);
      color: #e5e7eb;
    }
    .card {
      background: var(--card-dark) !important;
      border-color: var(--border-dark) !important;
    }
    .muted {
      color: var(--text-muted-dark) !important;
    }
  }

  /* üè´ WATERMARK */
  .watermark::before {
    content: "";
    position: fixed;
    inset: 0;
    background-image: url("{% if student.school.logo %}{{ student.school.logo.url }}{% endif %}");
    background-repeat: no-repeat;
    background-position: center;
    background-size: 300px;
    opacity: 0.05;
    pointer-events: none;
    z-index: 0;
  }

  /* üñ®Ô∏è PRINT */
  @media print {
    body {
      background: white !important;
      color: black !important;
    }
    .no-print {
      display: none !important;
    }
    .card {
      box-shadow: none !important;
      border: 1px solid #ddd !important;
    }
    .watermark::before {
      opacity: 0.08;
      background-size: 420px;
    }
    @page {
      size: A4;
      margin: 15mm;
    }
  }
</style>

<div class="watermark relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 min-h-screen bg-gradient-to-br from-indigo-50 via-white to-blue-50">

  <!-- üßë‚Äçüéì HEADER -->
  <div class="card bg-white border rounded-2xl shadow-sm p-4 sm:p-6 mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 flex-wrap">
    <div class="flex items-center gap-4 flex-wrap">
      {% if student.photo %}
        <img src="{{ student.photo.url }}" class="w-12 h-12 sm:w-16 sm:h-16 rounded-full object-cover border">
      {% else %}
        <div class="w-12 h-12 sm:w-16 sm:h-16 rounded-full bg-indigo-100 flex items-center justify-center font-bold text-indigo-600 text-lg">
          {{ student.full_name|slice:":1" }}
        </div>
      {% endif %}
      <div>
        <h1 class="text-lg sm:text-2xl font-bold" style="color:var(--theme)">
          {{ student.full_name }}
        </h1>
        <p class="text-xs sm:text-sm muted">
          {{ student.school_class }} ¬∑ {{ student.admission_no }}
        </p>
      </div>
    </div>

    <a href="{% url 'students:profile' %}"
       class="no-print inline-flex justify-center px-4 py-2 text-sm text-white rounded-lg shadow mt-2 sm:mt-0"
       style="background:var(--theme)">
      Edit Profile
    </a>
  </div>

  <!-- üìä PERFORMANCE -->
  <div class="card bg-white rounded-xl shadow-md border p-4 sm:p-6 mb-6">
    <h2 class="font-semibold mb-4" style="color:var(--theme)">Performance Summary</h2>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
      <div>
        <p class="text-2xl sm:text-3xl font-bold" style="color:var(--theme)">
          {{ average_score|default:"--" }}%
        </p>
        <p class="text-xs muted">Average Score</p>
      </div>
      <div>
        <p class="text-2xl sm:text-3xl font-bold text-green-600">
          {{ passed_exams|default:0 }}
        </p>
        <p class="text-xs muted">Passed</p>
      </div>
      <div>
        <p class="text-2xl sm:text-3xl font-bold text-blue-600">
          {{ total_exams|default:0 }}
        </p>
        <p class="text-xs muted">Total</p>
      </div>
    </div>

    {% if average_score %}
    <div class="mt-4">
      <div class="flex justify-between text-xs muted mb-1">
        <span>Progress</span>
        <span>{{ average_score }}%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div class="h-2 rounded-full"
             style="width:{{ average_score }}%;background:var(--theme)"></div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- üìÅ PROFILE + RESULTS -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

    <!-- PAYMENT -->
    <div class="card bg-white p-4 sm:p-6 rounded-xl shadow border">
      <h2 class="font-semibold mb-3" style="color:var(--theme)">Payment</h2>
      <ul class="text-sm space-y-2">
        <li><strong>Name:</strong> {{ student.full_name }}</li>
        <li><strong>Class:</strong> {{ student.school_class }}</li>
        <li class="no-print">
          <a href="{% url 'finance:student_dashboard'%}"
             class="inline-block px-3 py-1 text-xs text-white rounded"
             style="background:var(--theme)">
            View Payment
          </a>
        </li>
      </ul>
    </div>

    <!-- RESULTS -->
    <div class="card bg-white p-4 sm:p-6 rounded-xl shadow border flex flex-col gap-3">
      <h2 class="font-semibold mb-2" style="color:var(--theme)">Recent Results</h2>

      {% if recent_results %}
        <div class="flex flex-wrap gap-2">
          {% for submission in recent_results %}
            <a href="{% url 'cbt:student_exam_result' submission.exam.id %}"
               class="no-print px-3 py-1 text-xs sm:text-sm text-white rounded"
               style="background:var(--theme)">
              {{ submission.exam.title }} ‚Äî {{ submission.score }}%
            </a>
          {% endfor %}
        </div>
      {% else %}
        <span class="text-gray-500 text-sm">No recent results</span>
      {% endif %}
    </div>

  </div>

  <!-- üìù ASSIGNMENTS + NOTES -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">

    <!-- ASSIGNMENTS -->
    <div class="card bg-white p-4 sm:p-6 rounded-xl shadow border">
      <h2 class="font-semibold mb-4" style="color:var(--theme)">Assignments</h2>
      <ul class="divide-y">
        {% for a in assignments %}
        <li class="py-3 flex justify-between text-sm flex-wrap">
          <div>
            <p class="font-medium">{{ a.title }}</p>
            <p class="text-xs muted">{{ a.due_date|date:"M d, Y" }}</p>
          </div>
          {% if a.due_date < now %}
            <span class="text-xs text-red-600 mt-1 sm:mt-0">Overdue</span>
          {% else %}
            <span class="text-xs text-green-600 mt-1 sm:mt-0">Active</span>
          {% endif %}
        </li>
        {% empty %}
        <li class="py-3 text-center text-sm muted">No assignments</li>
        {% endfor %}
      </ul>
    </div>

    <!-- NOTES -->
    <div class="card bg-white p-4 sm:p-6 rounded-xl shadow border flex flex-col justify-between">
      <div>
        <h2 class="font-semibold mb-2" style="color:var(--theme)">Class Notes</h2>
        <p class="text-sm muted">Access all uploaded notes.</p>
      </div>
      <a href="{% url 'students:notes_list' %}"
         class="no-print mt-4 px-4 py-2 text-sm text-white rounded text-center"
         style="background:var(--theme)">
        View Notes
      </a>
    </div>
  </div>

  <!-- üíª CBT -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- ACTIVE -->
    <div class="card bg-white p-4 sm:p-6 rounded-xl shadow border">
      <h2 class="font-semibold mb-4" style="color:var(--theme)">Active CBT Exams</h2>
      {% if active_cbts %}
        <ul class="space-y-3">
          {% for exam in active_cbts %}
          <li class="flex justify-between text-sm flex-wrap">
            <div>
              <p class="font-medium">{{ exam.title }} ({{ exam.subject }})</p>
              <p class="text-xs muted">{{ exam.start_time|date:"M d, Y H:i" }}</p>
            </div>
            <a href="{% url 'cbt:exam_list' %}"
               class="no-print px-3 py-1 text-xs text-white rounded mt-1 sm:mt-0"
               style="background:var(--theme)">Start</a>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm muted">No active CBTs.</p>
      {% endif %}
    </div>

    <!-- UPCOMING -->
    <div class="card bg-white p-4 sm:p-6 rounded-xl shadow border">
      <h2 class="font-semibold mb-4" style="color:var(--theme)">Upcoming CBT Exams</h2>
      {% if upcoming_cbts %}
        <ul class="space-y-3">
          {% for exam in upcoming_cbts %}
          <li class="text-sm">
            <p class="font-medium">{{ exam.title }} ({{ exam.subject }})</p>
            <p class="text-xs muted">{{ exam.start_time|date:"M d, Y H:i" }}</p>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm muted">No upcoming CBTs.</p>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
